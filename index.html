<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Varpimoveis - Gest칚o Imobili치ria</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
      tailwind.config = {
        theme: {
          extend: {
            fontFamily: {
              sans: ['Inter', 'sans-serif'],
            }
          }
        }
      }
    </script>
    
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>

    <style>
      body {
        background-color: #f8fafc; /* Slate-50 */
        color: #1e293b; /* Slate-800 */
        font-family: 'Inter', -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
      }
      
      /* Custom scrollbar */
      .custom-scrollbar::-webkit-scrollbar {
        height: 6px;
        width: 6px;
      }
      .custom-scrollbar::-webkit-scrollbar-track {
        background: transparent;
      }
      .custom-scrollbar::-webkit-scrollbar-thumb {
        background: #cbd5e1;
        border-radius: 10px;
      }
      .custom-scrollbar::-webkit-scrollbar-thumb:hover {
        background: #94a3b8;
      }

      .hidden { display: none !important; }
      
      .fade-in {
        animation: fadeIn 0.3s ease-in-out;
      }
      @keyframes fadeIn {
        from { opacity: 0; transform: translateY(5px); }
        to { opacity: 1; transform: translateY(0); }
      }
    </style>
<script type="importmap">
{
  "imports": {
    "react": "https://esm.sh/react@^19.2.3",
    "react-dom/": "https://esm.sh/react-dom@^19.2.3/",
    "react/": "https://esm.sh/react@^19.2.3/",
    "firebase/": "https://esm.sh/firebase@^12.6.0/",
    "react-hook-form": "https://esm.sh/react-hook-form@^7.68.0",
    "react-router-dom": "https://esm.sh/react-router-dom@^7.10.1",
    "lucide-react": "https://esm.sh/lucide-react@^0.561.0"
  }
}
</script>
</head>
<body>

    <!-- HEADER -->
    <header class="bg-white border-t-4 border-t-emerald-900 border-b border-b-slate-200 shadow-sm sticky top-0 z-30">
        <div class="w-full px-4 sm:px-6 lg:px-8 h-16 flex items-center justify-between">
          <div class="flex items-center gap-4 cursor-pointer" onclick="window.App.navigateTo('dashboard')">
            <div class="flex flex-col items-start justify-center">
                 <div class="text-green-800 font-bold text-xl tracking-tighter leading-none">
                  VARP <span class="text-gray-600 text-xs font-normal tracking-normal">Im칩veis</span>
                 </div>
                 <div class="text-[9px] text-yellow-600 font-serif italic">Desde 1978</div>
            </div>
            <div class="h-6 w-px bg-slate-200 mx-2 hidden sm:block"></div>
            <h1 class="text-sm font-medium text-slate-500 hidden sm:block tracking-tight">
              Painel de Loca칞칚o
            </h1>
          </div>
          
          <!-- Bairro Filter Input in Header -->
          <div class="flex-1 max-w-xs mx-4 hidden md:block relative group">
              <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                  <i data-lucide="map-pin" class="h-3.5 w-3.5 text-slate-400 group-focus-within:text-emerald-600 transition-colors"></i>
              </div>
              <input 
                  type="text" 
                  id="header-bairro-filter"
                  oninput="window.App.handleBairroFilter(this.value)"
                  class="block w-full pl-9 pr-3 py-1.5 rounded-full border border-slate-200 bg-slate-50 text-slate-900 placeholder-slate-400 focus:outline-none focus:ring-2 focus:ring-emerald-500/20 focus:border-emerald-500/50 focus:bg-white transition-all text-xs font-medium"
                  placeholder="Filtrar por bairro..."
              />
          </div>
          
          <div class="flex items-center gap-2">
            <div class="hidden md:flex items-center gap-1 mr-2 bg-slate-100 rounded-full p-0.5">
              <button onclick="window.App.exportCSV()" title="Exportar CSV" class="p-1.5 text-slate-500 hover:text-emerald-700 hover:bg-white rounded-full transition-all shadow-sm">
                <i data-lucide="download" class="w-3.5 h-3.5"></i>
              </button>
              <button onclick="window.App.restoreDefaults()" title="Restaurar Padr칚o (Demo)" class="p-1.5 text-slate-500 hover:text-amber-600 hover:bg-white rounded-full transition-all shadow-sm">
                <i data-lucide="rotate-ccw" class="w-3.5 h-3.5"></i>
              </button>
              <button onclick="window.App.clearAll()" title="Limpar Tudo" class="p-1.5 text-slate-500 hover:text-red-600 hover:bg-white rounded-full transition-all shadow-sm">
                <i data-lucide="trash-2" class="w-3.5 h-3.5"></i>
              </button>
            </div>

            <button onclick="window.App.navigateTo('form')" class="inline-flex items-center px-4 py-2 border border-transparent rounded-lg shadow-md text-xs font-bold text-white bg-emerald-800 hover:bg-emerald-900 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-emerald-500 transition-all transform hover:-translate-y-0.5">
              <i data-lucide="plus" class="w-4 h-4 mr-1.5"></i>
              Novo
            </button>
          </div>
        </div>
    </header>

    <!-- DASHBOARD VIEW -->
    <main id="view-dashboard" class="w-full px-4 sm:px-6 lg:px-8 mt-6 pb-20 fade-in">
        
        <!-- Loading Indicator -->
        <div id="loading-indicator" class="w-full text-center py-4 text-slate-500">
            Carregando dados do banco de dados...
        </div>

        <!-- Stats Cards -->
        <div class="grid grid-cols-2 md:grid-cols-4 gap-3 mb-3">
             <div onclick="window.App.setFilter('status', 'Locado')" id="card-receita-ativa" class="relative p-3 rounded-xl border transition-all duration-200 cursor-pointer group hover:shadow-md bg-emerald-50/60 border-emerald-100 shadow-sm">
                <div class="flex items-center justify-between mb-1">
                    <span class="text-[10px] font-bold uppercase tracking-wider text-slate-500 group-hover:text-slate-700">Receita Mensal</span>
                    <div class="p-1 rounded-lg bg-emerald-100 text-emerald-700">
                        <i data-lucide="dollar-sign" class="w-4 h-4"></i>
                    </div>
                </div>
                <div class="flex flex-col">
                    <span class="text-lg font-bold tracking-tight text-emerald-700" id="stat-receita-ativa">R$ 0</span>
                </div>
            </div>

            <div onclick="window.App.setFilter('status', 'Dispon칤vel')" id="card-receita-potencial" class="relative p-3 rounded-xl border transition-all duration-200 cursor-pointer group hover:shadow-md bg-slate-50 border-slate-200">
                <div class="flex items-center justify-between mb-1">
                    <span class="text-[10px] font-bold uppercase tracking-wider text-slate-500 group-hover:text-slate-700">Receita Potencial</span>
                    <div class="p-1 rounded-lg bg-slate-200 text-slate-500">
                        <i data-lucide="trending-up" class="w-4 h-4"></i>
                    </div>
                </div>
                <div class="flex flex-col">
                    <span class="text-lg font-bold tracking-tight text-slate-500" id="stat-receita-potencial">R$ 0</span>
                </div>
            </div>

             <div onclick="window.App.resetFilters()" id="card-total" class="relative p-3 rounded-xl border transition-all duration-200 cursor-pointer group hover:shadow-md bg-white border-slate-200">
                <div class="flex items-center justify-between mb-1">
                    <span class="text-[10px] font-bold uppercase tracking-wider text-slate-500 group-hover:text-slate-700">Total Im칩veis</span>
                    <div class="p-1 rounded-lg bg-blue-100 text-blue-700">
                        <i data-lucide="building-2" class="w-4 h-4"></i>
                    </div>
                </div>
                <div class="flex flex-col">
                    <span class="text-lg font-bold tracking-tight text-blue-700" id="stat-total">0</span>
                    <span class="text-[9px] text-slate-400 font-medium" id="stat-total-sub">0 Res. | 0 Com.</span>
                </div>
            </div>

             <div class="relative p-3 rounded-xl border transition-all duration-200 cursor-default bg-white border-slate-200">
                <div class="flex items-center justify-between mb-1">
                    <span class="text-[10px] font-bold uppercase tracking-wider text-slate-500">Ocupa칞칚o</span>
                    <div class="p-1 rounded-lg bg-indigo-100 text-indigo-600">
                        <i data-lucide="briefcase" class="w-4 h-4"></i>
                    </div>
                </div>
                <div class="flex flex-col">
                    <span class="text-lg font-bold tracking-tight text-indigo-600" id="stat-ocupacao">0%</span>
                    <span class="text-[9px] text-slate-400 font-medium">Taxa atual</span>
                </div>
            </div>
        </div>

        <div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-5 gap-3 mb-5">
             <div onclick="window.App.setFilter('status', 'Dispon칤vel')" id="card-status-disponivel" class="relative p-3 rounded-xl border transition-all duration-200 cursor-pointer group hover:shadow-md bg-white border-emerald-100">
                <div class="flex items-center justify-between mb-1">
                    <span class="text-[10px] font-bold uppercase tracking-wider text-slate-500">Dispon칤veis</span>
                    <div class="p-1 rounded-lg bg-emerald-50 text-emerald-600">
                        <i data-lucide="key" class="w-3.5 h-3.5"></i>
                    </div>
                </div>
                <div class="flex flex-col">
                    <span class="text-xl font-bold tracking-tight text-emerald-600" id="stat-disponivel">0</span>
                </div>
            </div>

            <div onclick="window.App.setFilter('status', 'Em processo de loca칞칚o')" id="card-status-processo" class="relative p-3 rounded-xl border transition-all duration-200 cursor-pointer group hover:shadow-md bg-white border-amber-100">
                <div class="flex items-center justify-between mb-1">
                    <span class="text-[10px] font-bold uppercase tracking-wider text-slate-500">Em Processo</span>
                    <div class="p-1 rounded-lg bg-amber-50 text-amber-600">
                        <i data-lucide="clock" class="w-3.5 h-3.5"></i>
                    </div>
                </div>
                <div class="flex flex-col">
                    <span class="text-xl font-bold tracking-tight text-amber-600" id="stat-processo">0</span>
                </div>
            </div>

            <div onclick="window.App.setFilter('status', 'Desocupando')" id="card-status-desocupando" class="relative p-3 rounded-xl border transition-all duration-200 cursor-pointer group hover:shadow-md bg-white border-purple-100">
                <div class="flex items-center justify-between mb-1">
                    <span class="text-[10px] font-bold uppercase tracking-wider text-slate-500">Desocupando</span>
                    <div class="p-1 rounded-lg bg-purple-50 text-purple-600">
                        <i data-lucide="log-out" class="w-3.5 h-3.5"></i>
                    </div>
                </div>
                <div class="flex flex-col">
                    <span class="text-xl font-bold tracking-tight text-purple-600" id="stat-desocupando">0</span>
                </div>
            </div>

            <div onclick="window.App.setFilter('status', 'Suspenso')" id="card-status-suspenso" class="relative p-3 rounded-xl border transition-all duration-200 cursor-pointer group hover:shadow-md bg-slate-50 border-slate-200">
                <div class="flex items-center justify-between mb-1">
                    <span class="text-[10px] font-bold uppercase tracking-wider text-slate-500">Suspensos</span>
                    <div class="p-1 rounded-lg bg-slate-200 text-slate-500">
                        <i data-lucide="pause-circle" class="w-3.5 h-3.5"></i>
                    </div>
                </div>
                <div class="flex flex-col">
                    <span class="text-xl font-bold tracking-tight text-slate-500" id="stat-suspenso">0</span>
                </div>
            </div>

            <div onclick="window.App.setFilter('status', 'Locado')" id="card-status-locado" class="relative p-3 rounded-xl border transition-all duration-200 cursor-pointer group hover:shadow-md bg-white border-red-100">
                <div class="flex items-center justify-between mb-1">
                    <span class="text-[10px] font-bold uppercase tracking-wider text-slate-500">Locados</span>
                    <div class="p-1 rounded-lg bg-red-50 text-red-500">
                        <i data-lucide="check-circle" class="w-3.5 h-3.5"></i>
                    </div>
                </div>
                <div class="flex flex-col">
                    <span class="text-xl font-bold tracking-tight text-red-500" id="stat-locado">0</span>
                </div>
            </div>
        </div>

        <!-- Filter Bar -->
        <div class="bg-white p-1 rounded-xl shadow-sm border border-slate-200 flex flex-col md:flex-row md:items-center justify-between gap-3 mb-4 relative z-10">
            <div class="relative flex-1">
                <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                  <i data-lucide="search" class="h-4 w-4 text-slate-400"></i>
                </div>
                <input
                  type="text"
                  id="search-input"
                  oninput="window.App.handleSearch(this.value)"
                  class="block w-full pl-9 pr-16 py-2 rounded-lg border-none bg-slate-50 text-slate-900 placeholder-slate-400 focus:outline-none focus:ring-2 focus:ring-emerald-500/20 focus:bg-white transition-colors text-xs font-medium"
                  placeholder="Ex: Centro Jo칚o (Busca m칰ltipla...)"
                />
                <div id="search-feedback" class="absolute inset-y-0 right-0 pr-2 flex items-center gap-2 hidden">
                    <span id="search-count" class="bg-emerald-100 text-emerald-800 text-[10px] font-bold px-2 py-0.5 rounded-full border border-emerald-200 shadow-sm">
                        0
                    </span>
                    <button onclick="window.App.clearSearch()" class="p-1 text-slate-400 hover:text-slate-600 hover:bg-slate-200 rounded-full transition-colors" title="Limpar busca">
                        <i data-lucide="x" class="w-3 h-3"></i>
                    </button>
                </div>
            </div>

            <div class="flex items-center gap-2 pr-1">
                <div class="relative">
                    <button onclick="window.App.toggleStatusDropdown()" id="status-filter-btn" class="flex items-center justify-between min-w-[180px] bg-slate-50 hover:bg-slate-100 rounded-lg px-3 py-2 border border-slate-200 text-xs font-medium text-slate-700 focus:outline-none focus:ring-2 focus:ring-emerald-500/20 transition-all">
                        <div class="flex items-center">
                            <i data-lucide="filter" class="h-3.5 w-3.5 text-slate-400 mr-2"></i>
                            <span class="mr-2">Status:</span>
                            <span id="status-indicator" class="w-1.5 h-1.5 rounded-full mr-2 bg-slate-300"></span>
                            <span id="status-label" class="text-slate-900 font-semibold truncate max-w-[100px]">Todos</span>
                        </div>
                        <i data-lucide="chevron-down" class="h-3.5 w-3.5 text-slate-400"></i>
                    </button>
                    
                    <div id="status-dropdown" class="hidden absolute right-0 mt-2 w-56 bg-white rounded-xl shadow-xl border border-slate-100 z-50 overflow-hidden">
                        <div class="py-1">
                            <button onclick="window.App.setFilter('status', 'Todos')" class="w-full text-left px-4 py-2 text-xs flex items-center hover:bg-slate-50 text-slate-700">
                                <span class="w-2 h-2 rounded-full bg-slate-300 mr-3"></span> Todos os Status
                            </button>
                            <div class="border-t border-slate-50 my-1"></div>
                            <button onclick="window.App.setFilter('status', 'Dispon칤vel')" class="w-full text-left px-4 py-2 text-xs flex items-center hover:bg-slate-50 text-slate-700">
                                <span class="w-2 h-2 rounded-full bg-emerald-500 mr-3 shadow-sm"></span> Dispon칤vel
                            </button>
                            <button onclick="window.App.setFilter('status', 'Em processo de loca칞칚o')" class="w-full text-left px-4 py-2 text-xs flex items-center hover:bg-slate-50 text-slate-700">
                                <span class="w-2 h-2 rounded-full bg-amber-500 mr-3 shadow-sm"></span> Em processo de loca칞칚o
                            </button>
                            <button onclick="window.App.setFilter('status', 'Desocupando')" class="w-full text-left px-4 py-2 text-xs flex items-center hover:bg-slate-50 text-slate-700">
                                <span class="w-2 h-2 rounded-full bg-purple-500 mr-3 shadow-sm"></span> Desocupando
                            </button>
                            <button onclick="window.App.setFilter('status', 'Locado')" class="w-full text-left px-4 py-2 text-xs flex items-center hover:bg-slate-50 text-slate-700">
                                <span class="w-2 h-2 rounded-full bg-red-500 mr-3 shadow-sm"></span> Locado
                            </button>
                            <button onclick="window.App.setFilter('status', 'Suspenso')" class="w-full text-left px-4 py-2 text-xs flex items-center hover:bg-slate-50 text-slate-700">
                                <span class="w-2 h-2 rounded-full bg-slate-400 mr-3 shadow-sm"></span> Suspenso
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Table -->
        <div class="bg-white shadow-lg shadow-slate-200/50 rounded-2xl overflow-hidden border border-slate-100">
            <div class="overflow-x-auto custom-scrollbar">
                <table class="min-w-full divide-y divide-slate-100 table-fixed">
                    <thead class="bg-slate-50/80">
                        <tr>
                            <th onclick="window.App.sortBy('codigo')" class="w-24 px-4 py-3 text-left text-[10px] font-bold text-slate-500 uppercase tracking-wider cursor-pointer hover:bg-slate-100 whitespace-nowrap">C칩digo <i data-lucide="arrow-up-down" class="inline w-3 h-3 ml-1"></i></th>
                            <th onclick="window.App.sortBy('bairro')" class="w-32 px-4 py-3 text-left text-[10px] font-bold text-slate-500 uppercase tracking-wider cursor-pointer hover:bg-slate-100 whitespace-nowrap">Bairro</th>
                            <th onclick="window.App.sortBy('tipo')" class="w-24 px-4 py-3 text-left text-[10px] font-bold text-slate-500 uppercase tracking-wider cursor-pointer hover:bg-slate-100 whitespace-nowrap">Tipo</th>
                            <th class="w-48 px-4 py-3 text-left text-[10px] font-bold text-slate-500 uppercase tracking-wider whitespace-nowrap">Descri칞칚o</th>
                            <th class="w-32 px-4 py-3 text-left text-[10px] font-bold text-slate-500 uppercase tracking-wider whitespace-nowrap">Obs</th>
                            <th onclick="window.App.sortBy('endereco')" class="w-48 px-4 py-3 text-left text-[10px] font-bold text-slate-500 uppercase tracking-wider cursor-pointer hover:bg-slate-100 whitespace-nowrap">Endere칞o</th>
                            <th onclick="window.App.sortBy('valor')" class="w-28 px-4 py-3 text-left text-[10px] font-bold text-slate-500 uppercase tracking-wider cursor-pointer hover:bg-slate-100 whitespace-nowrap">Valor</th>
                            <th onclick="window.App.sortBy('fichaStatus')" class="w-28 px-4 py-3 text-left text-[10px] font-bold text-slate-500 uppercase tracking-wider cursor-pointer hover:bg-slate-100 whitespace-nowrap">Ficha</th>
                            <th onclick="window.App.sortBy('status')" class="w-28 px-4 py-3 text-left text-[10px] font-bold text-slate-500 uppercase tracking-wider cursor-pointer hover:bg-slate-100 whitespace-nowrap">Status</th>
                            <th onclick="window.App.sortBy('dataAtualizacao')" class="w-32 px-4 py-3 text-left text-[10px] font-bold text-slate-500 uppercase tracking-wider cursor-pointer hover:bg-slate-100 whitespace-nowrap">Atualiza칞칚o</th>
                            <th class="w-16 px-4 py-3"></th>
                        </tr>
                    </thead>
                    <tbody id="properties-table-body" class="bg-white divide-y divide-slate-50"></tbody>
                </table>
            </div>
            <div id="empty-state" class="hidden px-6 py-16 text-center text-slate-400">
                 <div class="flex flex-col items-center justify-center">
                    <i data-lucide="search" class="w-12 h-12 mb-4 text-slate-200"></i>
                    <p class="text-lg font-medium">Nenhum im칩vel encontrado</p>
                 </div>
            </div>
        </div>
    </main>

    <!-- FORM VIEW (Hidden by default) -->
    <div id="view-form" class="hidden min-h-screen bg-slate-50 pb-20 fade-in">
        <div class="w-full max-w-7xl mx-auto p-4 sm:p-8">
            <div class="flex items-center justify-between mb-8">
                <div class="flex items-center gap-3">
                     <div class="p-2 bg-emerald-900 rounded-lg text-white shadow-md">
                         <i data-lucide="building-2" class="w-6 h-6"></i>
                     </div>
                     <h1 id="form-title" class="text-2xl font-bold text-slate-900 tracking-tight">Cadastrar Novo Im칩vel</h1>
                </div>
                <button onclick="window.App.navigateTo('dashboard')" class="flex items-center text-slate-600 hover:text-emerald-800 hover:bg-white transition-all font-medium text-sm bg-slate-50 px-4 py-2 rounded-lg shadow-sm border border-slate-200">
                <i data-lucide="arrow-left" class="w-4 h-4 mr-2"></i>
                Voltar para lista
                </button>
            </div>

            <form id="property-form" onsubmit="window.App.handleFormSubmit(event)" class="bg-white shadow-xl shadow-slate-200/60 rounded-2xl overflow-hidden border border-slate-100">
                <input type="hidden" id="form-id" />
                <div class="p-8 space-y-10">
                
                <!-- Section 1 -->
                <div>
                    <h2 class="text-sm font-bold text-emerald-800 uppercase tracking-wider border-b border-emerald-100 pb-2 mb-6 flex items-center">
                        <span class="w-2 h-2 rounded-full bg-emerald-500 mr-2"></span> Dados Principais
                    </h2>
                    <div class="grid grid-cols-1 sm:grid-cols-3 gap-6">
                        <div>
                            <label class="block text-sm font-medium text-slate-700 mb-1">C칩digo</label>
                            <input type="text" id="form-codigo" required class="block w-full rounded-lg border-slate-300 shadow-sm border p-2.5 focus:border-emerald-500 focus:outline-none focus:ring-1 focus:ring-emerald-500 sm:text-sm bg-white" placeholder="Ex: AP-100" />
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-slate-700 mb-1">Tipo</label>
                            <select id="form-tipo" class="block w-full rounded-lg border-slate-300 shadow-sm border p-2.5 focus:border-emerald-500 focus:outline-none focus:ring-1 focus:ring-emerald-500 sm:text-sm bg-white">
                                <option value="Casa">Casa</option>
                                <option value="Apartamento">Apartamento</option>
                                <option value="Kitnet">Kitnet</option>
                                <option value="Sala">Sala Comercial</option>
                                <option value="Loja">Loja</option>
                                <option value="Comercial">Im칩vel Comercial</option>
                                <option value="Garagem">Garagem</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-slate-700 mb-1">Valor Mensal (R$)</label>
                            <div class="relative rounded-md shadow-sm">
                                <div class="pointer-events-none absolute inset-y-0 left-0 flex items-center pl-3 z-10">
                                    <span class="text-slate-500 sm:text-sm">R$</span>
                                </div>
                                <input type="number" id="form-valor" step="0.01" required class="block w-full rounded-lg border-slate-300 shadow-sm border p-2.5 pl-10 focus:border-emerald-500 focus:outline-none focus:ring-1 focus:ring-emerald-500 sm:text-sm bg-white" placeholder="0,00" />
                            </div>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-slate-700 mb-1">Status Atual</label>
                            <select id="form-status" class="block w-full rounded-lg border-slate-300 shadow-sm border p-2.5 focus:border-emerald-500 focus:outline-none focus:ring-1 focus:ring-emerald-500 sm:text-sm bg-white">
                                <option value="Dispon칤vel">Dispon칤vel</option>
                                <option value="Em processo de loca칞칚o">Em processo de loca칞칚o</option>
                                <option value="Desocupando">Desocupando</option>
                                <option value="Suspenso">Suspenso</option>
                                <option value="Locado">Locado</option>
                            </select>
                        </div>
                        <div class="sm:col-span-2">
                            <label class="block text-sm font-medium text-slate-700 mb-1">Captador</label>
                            <input type="text" id="form-captador" required class="block w-full rounded-lg border-slate-300 shadow-sm border p-2.5 focus:border-emerald-500 focus:outline-none focus:ring-1 focus:ring-emerald-500 sm:text-sm bg-white" placeholder="Nome do colaborador respons치vel" />
                        </div>
                    </div>
                </div>

                <!-- Section 2 -->
                <div>
                    <h2 class="text-sm font-bold text-emerald-800 uppercase tracking-wider border-b border-emerald-100 pb-2 mb-6 flex items-center">
                        <span class="w-2 h-2 rounded-full bg-emerald-500 mr-2"></span> Localiza칞칚o
                    </h2>
                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-6">
                        <div class="sm:col-span-2">
                            <label class="block text-sm font-medium text-slate-700 mb-1">Endere칞o Completo</label>
                            <input type="text" id="form-endereco" required class="block w-full rounded-lg border-slate-300 shadow-sm border p-2.5 focus:border-emerald-500 focus:outline-none focus:ring-1 focus:ring-emerald-500 sm:text-sm bg-white" placeholder="Logradouro, n칰mero, complemento" />
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-slate-700 mb-1">Bairro</label>
                            <input type="text" id="form-bairro" required class="block w-full rounded-lg border-slate-300 shadow-sm border p-2.5 focus:border-emerald-500 focus:outline-none focus:ring-1 focus:ring-emerald-500 sm:text-sm bg-white" />
                        </div>
                    </div>
                </div>

                <!-- Section 3 -->
                <div>
                    <h2 class="text-sm font-bold text-emerald-800 uppercase tracking-wider border-b border-emerald-100 pb-2 mb-6 flex items-center">
                        <span class="w-2 h-2 rounded-full bg-emerald-500 mr-2"></span> Detalhes & Ficha
                    </h2>
                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-6">
                        <div class="sm:col-span-2">
                            <label class="block text-sm font-medium text-slate-700 mb-1">Descri칞칚o Detalhada</label>
                            <textarea id="form-descricao" rows="3" class="block w-full rounded-lg border-slate-300 shadow-sm border p-2.5 focus:border-emerald-500 focus:outline-none focus:ring-1 focus:ring-emerald-500 sm:text-sm bg-white" placeholder="Descreva os diferenciais..."></textarea>
                        </div>
                        <div class="sm:col-span-2">
                            <label class="block text-sm font-medium text-slate-700 mb-1">Observa칞칫es Internas</label>
                            <textarea id="form-observacao" rows="2" class="block w-full rounded-lg border-slate-300 shadow-sm border p-2.5 focus:border-emerald-500 focus:outline-none focus:ring-1 focus:ring-emerald-500 sm:text-sm bg-white" placeholder="Informa칞칫es extras..."></textarea>
                        </div>
                        <div class="bg-slate-50 p-4 rounded-lg border border-slate-200">
                            <label class="block text-sm font-medium text-slate-900 mb-1">Status da Ficha</label>
                            <select id="form-fichaStatus" class="block w-full rounded-lg border-slate-300 shadow-sm border p-2.5 focus:border-emerald-500 focus:outline-none focus:ring-1 focus:ring-emerald-500 sm:text-sm bg-white mb-2">
                                <option value="Sem ficha">Sem ficha</option>
                                <option value="Em andamento">Em andamento</option>
                                <option value="Aprovada">Aprovada</option>
                            </select>
                        </div>
                        <div class="bg-slate-50 p-4 rounded-lg border border-slate-200">
                            <label class="block text-sm font-medium text-slate-900 mb-1">Previs칚o de Desocupa칞칚o</label>
                            <input type="date" id="form-vagoEm" class="block w-full rounded-lg border-slate-300 shadow-sm border p-2.5 focus:border-emerald-500 focus:outline-none focus:ring-1 focus:ring-emerald-500 sm:text-sm bg-white" />
                        </div>
                        <div class="bg-slate-50 p-4 rounded-lg border border-slate-200">
                            <label class="block text-sm font-medium text-slate-900 mb-1">Liberado em</label>
                            <input type="date" id="form-liberadoEm" class="block w-full rounded-lg border-slate-300 shadow-sm border p-2.5 focus:border-emerald-500 focus:outline-none focus:ring-1 focus:ring-emerald-500 sm:text-sm bg-white" />
                        </div>
                    </div>
                </div>

                </div>
                <div class="px-8 py-5 bg-slate-50 border-t border-slate-200 flex justify-end">
                    <button type="submit" class="inline-flex items-center px-6 py-3 border border-transparent rounded-lg shadow-sm text-sm font-medium text-white bg-emerald-800 hover:bg-emerald-900 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-emerald-500 transition-all transform hover:-translate-y-0.5">
                        <i data-lucide="save" class="w-5 h-5 mr-2"></i>
                        Salvar Altera칞칫es
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- FIREBASE & LOGIC -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
        import { getFirestore, collection, addDoc, updateDoc, deleteDoc, doc, onSnapshot, query, orderBy, writeBatch, getDocs } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";

        // FIREBASE CONFIGURATION
        const firebaseConfig = {
          apiKey: "AIzaSyBg8yP8TQrT6m34EGlkExa5yhou4833U80",
          authDomain: "tabela-de-aluguel.firebaseapp.com",
          projectId: "tabela-de-aluguel",
          storageBucket: "tabela-de-aluguel.firebasestorage.app",
          messagingSenderId: "1083451634894",
          appId: "1:1083451634894:web:655c0791b3cd57751c8c9f"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        // --- APPLICATION LOGIC ---
        const App = {
            data: [],
            filter: {
                search: '',
                bairro: '',
                status: 'Todos',
                category: 'Todos',
                sortBy: 'dataAtualizacao',
                sortDesc: true
            },
            
            init: function() {
                this.setupRealtimeListener();
                
                // Event Listeners
                document.addEventListener('click', (e) => {
                    const dropdown = document.getElementById('status-dropdown');
                    const btn = document.getElementById('status-filter-btn');
                    if (!btn.contains(e.target) && !dropdown.contains(e.target)) {
                        dropdown.classList.add('hidden');
                    }
                    if (!e.target.closest('.action-menu-trigger') && !e.target.closest('.action-menu')) {
                        document.querySelectorAll('.action-menu').forEach(el => el.classList.add('hidden'));
                    }
                });
            },

            setupRealtimeListener: function() {
                const q = query(collection(db, 'imoveis'), orderBy('dataAtualizacao', 'desc'));
                onSnapshot(q, (snapshot) => {
                    this.data = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    document.getElementById('loading-indicator').classList.add('hidden');
                    this.render();
                }, (error) => {
                    console.error("Firebase Error:", error);
                    if (error.code === 'permission-denied') {
                         alert("游뚿 ACESSO NEGADO PELO FIREBASE 游뚿\n\nO banco de dados recusou a conex칚o.\n\nCOMO RESOLVER:\n1. V치 ao Console do Firebase > Firestore Database > Regras.\n2. Altere para: allow read, write: if true;\n3. Publique.");
                    }
                });
            },

            // Navigation
            navigateTo: function(view, id = null) {
                document.getElementById('view-dashboard').classList.add('hidden');
                document.getElementById('view-form').classList.add('hidden');
                
                if (view === 'dashboard') {
                    document.getElementById('view-dashboard').classList.remove('hidden');
                    this.render(); 
                } else if (view === 'form') {
                    document.getElementById('view-form').classList.remove('hidden');
                    this.resetForm();
                    if (id) this.loadForm(id);
                }
                lucide.createIcons();
            },

            // Form Handling
            resetForm: function() {
                document.getElementById('property-form').reset();
                document.getElementById('form-id').value = '';
                document.getElementById('form-title').innerText = 'Cadastrar Novo Im칩vel';
            },

            loadForm: function(id) {
                const item = this.data.find(p => p.id === id);
                if (!item) return;

                document.getElementById('form-title').innerText = 'Editar Im칩vel';
                document.getElementById('form-id').value = item.id;
                
                const fields = ['codigo', 'endereco', 'bairro', 'tipo', 'valor', 'descricao', 'observacao', 'status', 'captador', 'fichaStatus'];
                fields.forEach(f => {
                    if (document.getElementById(`form-${f}`)) document.getElementById(`form-${f}`).value = item[f] || '';
                });

                if (item.vagoEm) document.getElementById('form-vagoEm').value = new Date(item.vagoEm).toISOString().split('T')[0];
                if (item.liberadoEm) document.getElementById('form-liberadoEm').value = new Date(item.liberadoEm).toISOString().split('T')[0];
            },

            handleFormSubmit: async function(e) {
                e.preventDefault();
                const id = document.getElementById('form-id').value;
                const isNew = !id;

                const formData = {
                    codigo: document.getElementById('form-codigo').value,
                    endereco: document.getElementById('form-endereco').value,
                    bairro: document.getElementById('form-bairro').value,
                    tipo: document.getElementById('form-tipo').value,
                    valor: parseFloat(document.getElementById('form-valor').value),
                    descricao: document.getElementById('form-descricao').value,
                    observacao: document.getElementById('form-observacao').value,
                    status: document.getElementById('form-status').value,
                    captador: document.getElementById('form-captador').value,
                    fichaStatus: document.getElementById('form-fichaStatus').value,
                    dataAtualizacao: Date.now()
                };

                const vagoEmVal = document.getElementById('form-vagoEm').value;
                if (vagoEmVal) formData.vagoEm = new Date(vagoEmVal).getTime() + 86400000/2;
                
                const liberadoEmVal = document.getElementById('form-liberadoEm').value;
                if (liberadoEmVal) formData.liberadoEm = new Date(liberadoEmVal).getTime() + 86400000/2;

                try {
                    if (isNew) {
                        await addDoc(collection(db, 'imoveis'), formData);
                    } else {
                        await updateDoc(doc(db, 'imoveis', id), formData);
                    }
                    this.navigateTo('dashboard');
                    alert(isNew ? 'Im칩vel cadastrado!' : 'Im칩vel atualizado!');
                } catch (err) {
                    console.error(err);
                    alert("Erro ao salvar. Verifique o console.");
                }
            },

            // Actions
            deleteProperty: async function(id) {
                if (confirm('Tem certeza que deseja excluir este im칩vel?')) {
                    await deleteDoc(doc(db, 'imoveis', id));
                }
            },

            quickUpdateStatus: async function(id, status) {
                await updateDoc(doc(db, 'imoveis', id), { status: status, dataAtualizacao: Date.now() });
            },

            quickUpdateFicha: async function(id, status) {
                await updateDoc(doc(db, 'imoveis', id), { fichaStatus: status, dataAtualizacao: Date.now() });
                if(status === 'Aprovada') alert('Ficha Aprovada!');
            },

            // Filtering
            handleSearch: function(val) { this.filter.search = val; this.render(); },
            handleBairroFilter: function(val) { this.filter.bairro = val; this.render(); },
            clearSearch: function() { this.filter.search = ''; document.getElementById('search-input').value = ''; this.render(); },
            toggleStatusDropdown: function() { document.getElementById('status-dropdown').classList.toggle('hidden'); },
            setFilter: function(key, val) { this.filter[key] = val; this.render(); },
            resetFilters: function() { 
                this.filter.status = 'Todos'; 
                this.filter.search = ''; 
                this.filter.bairro = '';
                document.getElementById('search-input').value = ''; 
                document.getElementById('header-bairro-filter').value = ''; 
                this.render(); 
            },
            sortBy: function(field) {
                if (this.filter.sortBy === field) this.filter.sortDesc = !this.filter.sortDesc;
                else { this.filter.sortBy = field; this.filter.sortDesc = true; }
                this.render();
            },

            // Rendering
            getFilteredData: function() {
                let res = this.data.filter(p => {
                    const searchLower = this.filter.search.toLowerCase();
                    const terms = searchLower.split(/\s+/).filter(t => t.length > 0);
                    const matchesSearch = terms.length === 0 || terms.every(term => {
                        return (
                            p.codigo.toLowerCase().includes(term) ||
                            p.endereco.toLowerCase().includes(term) ||
                            p.bairro.toLowerCase().includes(term) ||
                            (p.captador && p.captador.toLowerCase().includes(term)) ||
                            (p.descricao && p.descricao.toLowerCase().includes(term)) ||
                            (p.observacao && p.observacao.toLowerCase().includes(term))
                        );
                    });
                    const matchesStatus = this.filter.status === 'Todos' || p.status === this.filter.status;
                    const matchesBairro = p.bairro.toLowerCase().includes(this.filter.bairro.toLowerCase());
                    return matchesSearch && matchesStatus && matchesBairro;
                });

                const field = this.filter.sortBy;
                const dir = this.filter.sortDesc ? -1 : 1;
                res.sort((a, b) => {
                    const valA = a[field] || ''; 
                    const valB = b[field] || '';
                    if (valA < valB) return -1 * dir;
                    if (valA > valB) return 1 * dir;
                    return 0;
                });
                return res;
            },

            render: function() {
                const filtered = this.getFilteredData();
                this.renderStats(this.data);
                this.renderTable(filtered);
                this.renderUIState();
                lucide.createIcons();
            },

            renderUIState: function() {
                document.getElementById('status-label').innerText = this.filter.status;
                const statusColors = { 'Todos': 'bg-slate-300', 'Dispon칤vel': 'bg-emerald-500', 'Em processo de loca칞칚o': 'bg-amber-500', 'Desocupando': 'bg-purple-500', 'Locado': 'bg-red-500', 'Suspenso': 'bg-slate-400' };
                document.getElementById('status-indicator').className = `w-2 h-2 rounded-full mr-2 ${statusColors[this.filter.status] || 'bg-slate-300'}`;
                
                ['card-receita-ativa', 'card-receita-potencial', 'card-total', 'card-status-disponivel', 'card-status-processo', 'card-status-desocupando', 'card-status-suspenso', 'card-status-locado'].forEach(id => document.getElementById(id).classList.remove('ring-2', 'ring-emerald-500', 'ring-offset-1'));
                
                const map = { 'Dispon칤vel': 'card-status-disponivel', 'Locado': 'card-status-locado', 'Desocupando': 'card-status-desocupando', 'Em processo de loca칞칚o': 'card-status-processo', 'Suspenso': 'card-status-suspenso' };
                if (this.filter.status === 'Todos') document.getElementById('card-total').classList.add('ring-2', 'ring-emerald-500', 'ring-offset-1');
                else if (map[this.filter.status]) document.getElementById(map[this.filter.status]).classList.add('ring-2', 'ring-emerald-500', 'ring-offset-1');

                const feedback = document.getElementById('search-feedback');
                if (this.filter.search) {
                    feedback.classList.remove('hidden');
                    document.getElementById('search-count').innerText = this.getFilteredData().length;
                } else {
                    feedback.classList.add('hidden');
                }
            },

            renderStats: function(data) {
                const stats = { total: 0, residencial: 0, comercial: 0, disponivel: 0, emProcesso: 0, desocupando: 0, suspenso: 0, locado: 0, receitaMensal: 0, potencialReceita: 0 };
                const CATEGORIA_RESIDENCIAL = ['Casa', 'Apartamento', 'Kitnet'];
                const CATEGORIA_COMERCIAL = ['Sala', 'Loja', 'Comercial', 'Garagem'];

                data.forEach(p => {
                    stats.total++;
                    const val = Number(p.valor) || 0;
                    if (CATEGORIA_RESIDENCIAL.includes(p.tipo)) stats.residencial++;
                    if (CATEGORIA_COMERCIAL.includes(p.tipo)) stats.comercial++;
                    if (p.status === 'Dispon칤vel') { stats.disponivel++; stats.potencialReceita += val; }
                    if (p.status === 'Em processo de loca칞칚o') { stats.emProcesso++; stats.potencialReceita += val; }
                    if (p.status === 'Desocupando') { stats.desocupando++; stats.receitaMensal += val; }
                    if (p.status === 'Suspenso') stats.suspenso++;
                    if (p.status === 'Locado') { stats.locado++; stats.receitaMensal += val; }
                });

                const fmt = (v) => new Intl.NumberFormat('pt-BR', { style: 'currency', currency: 'BRL', maximumFractionDigits: 0 }).format(v);
                document.getElementById('stat-receita-ativa').innerText = fmt(stats.receitaMensal);
                document.getElementById('stat-receita-potencial').innerText = fmt(stats.potencialReceita);
                document.getElementById('stat-total').innerText = stats.total;
                document.getElementById('stat-total-sub').innerText = `${stats.residencial} Res. | ${stats.comercial} Com.`;
                document.getElementById('stat-ocupacao').innerText = stats.total > 0 ? Math.round(((stats.locado + stats.desocupando) / stats.total) * 100) + '%' : '0%';
                document.getElementById('stat-disponivel').innerText = stats.disponivel;
                document.getElementById('stat-processo').innerText = stats.emProcesso;
                document.getElementById('stat-desocupando').innerText = stats.desocupando;
                document.getElementById('stat-suspenso').innerText = stats.suspenso;
                document.getElementById('stat-locado').innerText = stats.locado;
            },

            renderTable: function(properties) {
                const tbody = document.getElementById('properties-table-body');
                tbody.innerHTML = '';
                if (properties.length === 0) {
                    document.getElementById('empty-state').classList.remove('hidden');
                    return;
                }
                document.getElementById('empty-state').classList.add('hidden');

                properties.forEach(p => {
                    const tr = document.createElement('tr');
                    tr.className = "hover:bg-emerald-50/30 transition-colors group border-b border-slate-50 last:border-0";
                    
                    const fmtVal = (v) => new Intl.NumberFormat('pt-BR', { style: 'currency', currency: 'BRL' }).format(v);
                    const fmtDate = (d) => new Intl.DateTimeFormat('pt-BR', { day: '2-digit', month: '2-digit', hour: '2-digit', minute: '2-digit' }).format(new Date(d));
                    const statusStyles = { 'Dispon칤vel': 'bg-emerald-100 text-emerald-800 ring-emerald-600/20', 'Em processo de loca칞칚o': 'bg-amber-100 text-amber-800 ring-amber-600/20', 'Desocupando': 'bg-purple-100 text-purple-800 ring-purple-600/20', 'Suspenso': 'bg-slate-100 text-slate-600 ring-slate-500/10', 'Locado': 'bg-red-50 text-red-700 ring-red-600/10' };

                    let fichaBadge = `<span class="inline-flex items-center px-2.5 py-1 rounded-md text-xs font-semibold border bg-slate-100 text-slate-500 border-slate-200">Sem ficha</span>`;
                    if (p.fichaStatus === 'Em andamento') fichaBadge = `<span class="inline-flex items-center px-2.5 py-1 rounded-md text-xs font-semibold border bg-amber-50 text-amber-700 border-amber-200">Em andamento</span>`;
                    if (p.fichaStatus === 'Aprovada') fichaBadge = `<span class="inline-flex items-center px-2.5 py-1 rounded-md text-xs font-semibold border bg-emerald-50 text-emerald-700 border-emerald-200">Aprovada</span>`;

                    tr.innerHTML = `
                        <td class="px-6 py-4 whitespace-nowrap text-sm font-bold text-slate-800 tracking-tight">${p.codigo}</td>
                        <td class="px-6 py-4 text-sm text-slate-500">
                          <div class="block max-w-[120px] truncate" title="${(p.bairro || '').replace(/"/g, '&quot;')}">
                            ${p.bairro || ''}
                          </div>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-slate-500">${p.tipo}</td>
                        <td class="px-6 py-4 text-sm text-slate-500">
                          <div class="block max-w-[180px] truncate" title="${(p.descricao || '').replace(/"/g, '&quot;')}">
                             ${p.descricao || ''}
                          </div>
                        </td>
                        <td class="px-6 py-4 text-sm text-slate-500">
                           <div class="block max-w-[140px] truncate" title="${(p.observacao || '').replace(/"/g, '&quot;')}">
                             ${p.observacao || '-'}
                           </div>
                        </td>
                        <td class="px-6 py-4 text-sm text-slate-500">
                           <div class="block max-w-[180px] truncate cursor-help" title="${(p.endereco || '').replace(/"/g, '&quot;')}">
                             ${p.endereco || ''}
                           </div>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-emerald-800 font-bold bg-emerald-50/50 rounded-lg">${fmtVal(p.valor)}</td>
                        <td class="px-6 py-4 whitespace-nowrap">${fichaBadge}</td>
                        <td class="px-6 py-4 whitespace-nowrap"><span class="inline-flex items-center px-2.5 py-1 rounded-full text-xs font-semibold ring-1 ring-inset ${statusStyles[p.status]} shadow-sm">${p.status}</span></td>
                        <td class="px-6 py-4 whitespace-nowrap text-xs text-slate-400 font-medium">${fmtDate(p.dataAtualizacao)}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium relative">
                            <button onclick="window.App.toggleActionMenu('${p.id}')" class="action-menu-trigger p-2 rounded-full text-slate-300 hover:text-emerald-600 hover:bg-slate-50 transition-colors"><i data-lucide="more-horizontal" class="w-5 h-5 pointer-events-none"></i></button>
                            <div id="action-menu-${p.id}" class="action-menu hidden absolute right-0 mt-2 w-56 rounded-xl shadow-xl bg-white ring-1 ring-black ring-opacity-5 z-20 overflow-hidden text-left">
                                <div class="py-1">
                                    <button onclick="window.App.navigateTo('form', '${p.id}')" class="w-full text-left px-4 py-2.5 text-sm text-slate-700 hover:bg-slate-50 hover:text-emerald-700 flex items-center"><i data-lucide="edit" class="mr-3 h-4 w-4"></i> Editar Im칩vel</button>
                                    <div class="border-t border-slate-100 my-1"></div>
                                    <span class="block px-4 py-1.5 text-[10px] text-slate-400 uppercase tracking-wider font-bold">Situa칞칚o da Ficha</span>
                                    <button onclick="window.App.quickUpdateFicha('${p.id}', 'Em andamento')" class="w-full text-left px-4 py-2 text-sm text-slate-700 hover:bg-slate-50 flex items-center"><i data-lucide="file-text" class="w-4 h-4 mr-2 text-amber-500"></i> Em An치lise</button>
                                    <button onclick="window.App.quickUpdateFicha('${p.id}', 'Aprovada')" class="w-full text-left px-4 py-2 text-sm text-slate-700 hover:bg-slate-50 flex items-center"><i data-lucide="clipboard-check" class="w-4 h-4 mr-2 text-emerald-500"></i> Aprovada</button>
                                    <div class="border-t border-slate-100 my-1"></div>
                                    <span class="block px-4 py-1.5 text-[10px] text-slate-400 uppercase tracking-wider font-bold">Alterar Status</span>
                                    <button onclick="window.App.quickUpdateStatus('${p.id}', 'Dispon칤vel')" class="w-full text-left px-4 py-2 text-sm text-slate-700 hover:bg-slate-50 flex items-center"><i data-lucide="check-circle" class="w-4 h-4 mr-2 text-emerald-600"></i> Dispon칤vel</button>
                                    <button onclick="window.App.quickUpdateStatus('${p.id}', 'Locado')" class="w-full text-left px-4 py-2 text-sm text-slate-700 hover:bg-slate-50 flex items-center"><i data-lucide="building-2" class="w-4 h-4 mr-2 text-red-500"></i> Locado</button>
                                    <button onclick="window.App.quickUpdateStatus('${p.id}', 'Desocupando')" class="w-full text-left px-4 py-2 text-sm text-slate-700 hover:bg-slate-50 flex items-center"><i data-lucide="log-out" class="w-4 h-4 mr-2 text-purple-500"></i> Desocupando</button>
                                    <div class="border-t border-slate-100 my-1"></div>
                                    <button onclick="window.App.deleteProperty('${p.id}')" class="w-full text-left px-4 py-2.5 text-sm text-red-600 hover:bg-red-50 hover:text-red-700 flex items-center"><i data-lucide="trash-2" class="mr-3 h-4 w-4"></i> Excluir</button>
                                </div>
                            </div>
                        </td>
                    `;
                    tbody.appendChild(tr);
                });
            },

            toggleActionMenu: function(id) {
                document.querySelectorAll('.action-menu').forEach(el => { if (el.id !== `action-menu-${id}`) el.classList.add('hidden'); });
                document.getElementById(`action-menu-${id}`).classList.toggle('hidden');
            },

            restoreDefaults: function() {
                alert("Esta fun칞칚o est치 desabilitada no modo Banco de Dados Real para proteger suas informa칞칫es.");
            },

            clearAll: async function() {
                if (confirm('ATEN칂츾O: Isso apagar치 TODOS os im칩veis do banco de dados. Continuar?')) {
                    const q = query(collection(db, 'imoveis'));
                    const snapshot = await getDocs(q);
                    const batch = writeBatch(db);
                    snapshot.docs.forEach((doc) => batch.delete(doc.ref));
                    await batch.commit();
                }
            },

            exportCSV: function() {
                const filtered = this.getFilteredData();
                if (!filtered.length) return alert('Nada para exportar');
                const headers = ["C칩digo", "Endere칞o", "Bairro", "Tipo", "Valor", "Descri칞칚o", "Observa칞칚o", "Status", "Ficha", "Captador", "Data Atualiza칞칚o"];
                const rows = filtered.map(p => [
                    p.codigo, p.endereco, p.bairro, p.tipo, p.valor.toString().replace('.', ','),
                    `"${(p.descricao || '').replace(/"/g, '""')}"`,
                    `"${(p.observacao || '').replace(/"/g, '""')}"`,
                    p.status, p.fichaStatus || 'Sem ficha', p.captador,
                    new Date(p.dataAtualizacao).toLocaleDateString('pt-BR')
                ]);
                const csv = [headers.join(';'), ...rows.map(r => r.join(';'))].join('\n');
                const blob = new Blob(["\uFEFF" + csv], { type: 'text/csv;charset=utf-8;' });
                const url = URL.createObjectURL(blob);
                const link = document.createElement('a');
                link.href = url;
                link.download = `varp_imoveis_${new Date().toISOString().split('T')[0]}.csv`;
                link.click();
            }
        };

        // Expose App to global window for HTML onclick events
        window.App = App;

        // Start App
        document.addEventListener('DOMContentLoaded', () => {
            App.init();
        });
    </script>
</body>
</html>